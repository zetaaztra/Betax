# AegisMatrix Project Structure

This document outlines the complete project structure for AegisMatrix, a three-engine quant system for NIFTY options analysis.

## Project Overview

**AegisMatrix** is a unified intelligence platform for NIFTY options trading with three specialized engines:

1. **Direction Engine (AegisCore)**: Directional bias forecasts over multiple horizons
2. **Option Sellers Engine (RangeShield)**: Risk analytics for short strategies
3. **Option Buyers Engine (PulseWave)**: Volatility & spike analytics for long strategies

All three engines produce a **single JSON output** (`aegismatrix.json`) consumed by the React frontend.

---

## Directory Structure

```
aegis-dashboard/
│
├── client/                          # React frontend (Vite)
│   ├── index.html
│   ├── public/
│   │   └── data/
│   │       └── aegismatrix.json     # GENERATED by Python (read-only)
│   └── src/
│       ├── App.tsx
│       ├── main.tsx
│       ├── index.css
│       ├── components/
│       │   ├── concentric-background.tsx
│       │   ├── cookie-consent-modal.tsx
│       │   ├── disclaimer-modal.tsx
│       │   ├── footer.tsx
│       │   ├── how-to-use.tsx
│       │   ├── theme-provider.tsx
│       │   ├── tile-help-modal.tsx
│       │   ├── tabs/                # Tab containers (NEW)
│       │   │   ├── direction-tab.tsx
│       │   │   ├── seller-tab.tsx
│       │   │   └── buyer-tab.tsx
│       │   ├── tiles/               # Dashboard tiles (reorganized)
│       │   │   ├── direction/
│       │   │   │   ├── today-direction.tsx
│       │   │   │   ├── horizon-tile.tsx
│       │   │   │   ├── spot-tile.tsx
│       │   │   │   ├── vix-tile.tsx
│       │   │   │   ├── direction-risk.tsx
│       │   │   │   └── market-regime-tile.tsx
│       │   │   ├── seller/
│       │   │   │   ├── safe-range-tile.tsx
│       │   │   │   ├── max-pain-tile.tsx
│       │   │   │   ├── expiry-stress-tile.tsx
│       │   │   │   ├── vol-trap-tile.tsx
│       │   │   │   ├── skew-pressure-tile.tsx
│       │   │   │   ├── breach-curve.tsx
│       │   │   │   ├── seller-flag-tile.tsx
│       │   │   │   └── ...
│       │   │   ├── buyer/
│       │   │   │   ├── breakout-gauge.tsx
│       │   │   │   ├── breakout-horizon-map.tsx
│       │   │   │   ├── spike-direction-bias.tsx
│       │   │   │   ├── gamma-windows.tsx
│       │   │   │   ├── theta-edge-tile.tsx
│       │   │   │   ├── buyer-environment.tsx
│       │   │   │   └── ...
│       │   │   └── shared/          # Shared components (NEW)
│       │   │       ├── risk-score-dial.tsx
│       │   │       ├── mini-sparkline.tsx
│       │   │       └── probability-curve.tsx
│       │   └── ui/                  # Shadcn UI components
│       │       ├── button.tsx
│       │       ├── card.tsx
│       │       ├── dialog.tsx
│       │       └── ...
│       ├── hooks/
│       │   ├── use-mobile.tsx
│       │   └── use-toast.ts
│       ├── lib/
│       │   ├── queryClient.ts
│       │   ├── utils.ts
│       │   └── aegis-data.ts        # Load & decode aegismatrix.json (NEW)
│       └── pages/
│           ├── about.tsx
│           ├── buyer-view.tsx
│           ├── dashboard.tsx        # Tab layout wrapper
│           ├── seller-view.tsx
│           ├── privacy.tsx
│           ├── terms.tsx
│           └── ...
│
├── aegismatrix-engine/              # Python ML backend (NEW)
│   ├── config.py                    # Central config
│   ├── data_fetcher.py              # Single yfinance entry point
│   ├── infer.py                     # MAIN: run by GitHub Actions
│   ├── schema.py                    # JSON schema validation (Pydantic)
│   ├── requirements.txt
│   │
│   ├── features/
│   │   ├── __init__.py
│   │   ├── daily_features.py        # Feature engineering for direction/seller/buyer
│   │   └── intraday_features.py     # Intraday features (gap, ORB, vol windows)
│   │
│   ├── direction/                   # Direction Engine (AegisCore)
│   │   ├── __init__.py
│   │   ├── model.py                 # Load models, horizon predictions
│   │   ├── today_direction.py       # Combine daily + intraday → today tile
│   │   └── train_direction.py       # Local training only
│   │
│   ├── seller/                      # Seller Engine (RangeShield)
│   │   ├── __init__.py
│   │   ├── model.py                 # Safe range, trap, skew, expiry stress, breach
│   │   └── train_seller.py
│   │
│   ├── buyer/                       # Buyer Engine (PulseWave)
│   │   ├── __init__.py
│   │   ├── model.py                 # Breakout, spike bias, gamma windows
│   │   └── train_buyer.py
│   │
│   ├── models/                      # Saved model binaries
│   │   ├── direction_seq.pt         # or .pkl
│   │   ├── direction_magnitude.pkl
│   │   ├── seller_regime.pkl
│   │   ├── buyer_breakout.pt
│   │   └── ...
│   │
│   └── data/
│       ├── raw/                     # Raw yfinance downloads
│       ├── processed/               # Feature-engineered data
│       └── intraday/                # Intraday cache
│
├── server/                          # Express backend (optional)
│   ├── index.ts
│   ├── routes.ts
│   ├── storage.ts
│   └── vite.ts
│
├── shared/
│   └── schema.ts                    # TS types mirroring aegismatrix.json
│
├── .github/
│   └── workflows/
│       └── aegismatrix-infer-build.yml   # Run Python infer + Vite build + deploy
│
├── package.json
├── vite.config.ts
├── tsconfig.json
├── tailwind.config.ts
├── postcss.config.js
├── drizzle.config.ts
├── components.json
│
├── design_guidelines.md
└── attached_assets/
```

---

## Key Differences from Traditional Monolith

### **No API Server Needed**

- ✅ Python engine generates static `aegismatrix.json`
- ✅ Frontend reads JSON directly from `public/data/`
- ❌ No HTTP API, no WebSocket, no database required
- ❌ No live quotes (by design: structural signals only)

### **Three Separate Engines**

Each engine is **logically isolated**:

- `direction/`: Horizon forecasts (1–40 days)
- `seller/`: Range bands, trap risk, breach probabilities
- `buyer/`: Breakout potential, spike direction, gamma windows

### **Single Source of Truth: JSON**

```
aegismatrix.json (generated every 30 minutes)
   ↓
React reads & renders
   ↓
Three tabs: Direction | Sellers | Buyers
```

---

## Python Engine: Core Scripts

### **1. config.py**

Central configuration. No logic.

```python
NIFTY_SYMBOL = "^NSEI"
VIX_SYMBOL = "^INDIAVIX"
LOOKBACK_YEARS = 5
DIRECTION_HORIZONS = [1, 3, 5, 10, 20, 40]
JSON_OUTPUT_PATH = "../client/public/data/aegismatrix.json"
```

### **2. data_fetcher.py**

Single entry point to yfinance.

```python
def get_daily_history(symbol: str) -> pd.DataFrame
def get_intraday_history(symbol: str, period="5d", interval="5m") -> pd.DataFrame
def get_market_snapshots() -> Tuple[pd.DataFrame, pd.DataFrame]
```

### **3. features/daily_features.py**

Feature engineering for all engines.

```python
def build_direction_features(nifty, vix) -> pd.DataFrame
def build_seller_features(nifty, vix) -> pd.DataFrame
def build_buyer_features(nifty, vix) -> pd.DataFrame
```

### **4. features/intraday_features.py**

Intraday context (gap, ORB, vol windows).

```python
def build_today_direction_features(intraday, previous_close) -> dict
def build_gamma_window_features(intraday) -> list[dict]
```

### **5. direction/model.py**

Direction engine predictions.

```python
def predict_direction_horizons(features_df, horizons) -> dict
def predict_direction_risk_score(features_df) -> float
def infer_regime(nifty_df, vix_df) -> str
```

### **6. direction/today_direction.py**

Combine daily bias + intraday features.

```python
def compute_today_direction(daily_bias, intraday_feats) -> dict
```

### **7. seller/model.py**

Seller engine outputs.

```python
def compute_safe_range(spot, vol, horizon_days) -> dict
def compute_vol_trap_risk(features_df) -> dict
def compute_skew_pressure(features_df) -> dict
def compute_expiry_stress(features_df) -> dict
def compute_breach_probability_curve(spot, vol) -> list[dict]
def compute_seller_flag(trap_score, expiry_stress) -> dict
```

### **8. buyer/model.py**

Buyer engine outputs.

```python
def compute_breakout_today(features_df) -> dict
def compute_breakout_next(features_df) -> list[dict]
def compute_spike_direction_bias(features_df) -> dict
def compute_gamma_windows(intraday_df) -> list[dict]
def compute_theta_edge_score(features_df) -> dict
def infer_buyer_regime(features_df) -> str
def compute_buyer_environment(breakout_today, theta_edge, regime) -> dict
```

### **9. infer.py** ⭐

Main inference script (run by GitHub Actions on schedule).

```python
def main():
    # 1. Fetch data
    nifty, vix = get_market_snapshots()
    intraday = get_intraday_history(...)
    
    # 2. Build features
    dir_feats = build_direction_features(nifty, vix)
    sel_feats = build_seller_features(nifty, vix)
    buy_feats = build_buyer_features(nifty, vix)
    
    # 3. Generate blocks
    market_block = build_market_block(...)
    direction_block = build_direction_block(...)
    seller_block = build_seller_block(...)
    buyer_block = build_buyer_block(...)
    
    # 4. Assemble & validate
    payload = {...}
    validate_payload(payload)
    
    # 5. Write
    with open(JSON_OUTPUT_PATH, "w") as f:
        json.dump(payload, f, indent=2)
```

### **10. schema.py**

Pydantic models for validation.

```python
class AegisMatrixPayload(BaseModel):
    generated_at: str
    market: MarketBlock
    direction: DirectionBlock
    seller: SellerBlock
    buyer: BuyerBlock

def validate_payload(payload: dict) -> None
```

---

## Frontend: React Components

### **Tabs** (`components/tabs/`)

- `direction-tab.tsx`: Today + horizons + risk score
- `seller-tab.tsx`: Safe range, trap, skew, expiry stress, breach
- `buyer-tab.tsx`: Breakout, spike, gamma, theta edge

### **Tiles** (`components/tiles/`)

Organized by engine:

- `direction/`: today-direction.tsx, horizon-tile.tsx, market-regime-tile.tsx, etc.
- `seller/`: safe-range-tile.tsx, max-pain-tile.tsx, trap-tile.tsx, etc.
- `buyer/`: breakout-gauge.tsx, gamma-windows.tsx, theta-edge-tile.tsx, etc.
- `shared/`: RiskScoreDial, MiniSparkline, ProbabilityCurve

### **Data Loading** (`lib/aegis-data.ts`)

```typescript
export async function loadAegisMatrixData(forceRefresh?: boolean): Promise<AegisMatrixData>
export function clearAegisMatrixCache(): void
export function getLastGeneratedTime(): string | null
```

---

## CI/CD: GitHub Actions

**File:** `.github/workflows/aegismatrix-infer-build.yml`

**Schedule:** Every 30 minutes during Indian market hours (UTC 03:45–10:00, Mon–Fri)

**Steps:**

1. Checkout code
2. Set up Python 3.11
3. Install Python dependencies (`aegismatrix-engine/requirements.txt`)
4. Run `python infer.py` → generates `client/public/data/aegismatrix.json`
5. Set up Node.js 20
6. Install npm dependencies
7. Build frontend (`npm run build` → `client/dist/`)
8. Deploy to Cloudflare Pages

---

## Training (Local Only)

Training scripts are **not** run in CI/CD:

- `direction/train_direction.py`
- `seller/train_seller.py`
- `buyer/train_buyer.py`

Run locally on your machine to retrain models. Save outputs to `aegismatrix-engine/models/`.

---

## Data Flow

```
GitHub Actions (schedule every 30 min)
    ↓
aegismatrix-engine/infer.py
    ├─ Fetch NIFTY + VIX daily & intraday (yfinance)
    ├─ Build features (daily_features.py, intraday_features.py)
    ├─ Direction engine: predict horizons, today direction, risk
    ├─ Seller engine: safe range, trap, skew, expiry stress, breach
    ├─ Buyer engine: breakout, spike, gamma, theta, environment
    ├─ Assemble payload (market, direction, seller, buyer)
    ├─ Validate with Pydantic schema
    └─ Write to client/public/data/aegismatrix.json
        ↓
    Vite build: client/dist/
        ↓
    Deploy to Cloudflare Pages (static)
        ↓
    Browser fetches aegismatrix.json & renders three tabs
```

---

## Important Notes

1. **No trade calls**: This system forecasts bias, not specific strike recommendations.
2. **Delayed data**: yfinance has ~15–30 minute lag. Designed for structural signals, not tick trading.
3. **Backtest first**: All three engines must be validated offline before deployment.
4. **Static file**: The JSON is read-only from the browser. Frontend cannot modify it.
5. **Placeholder models**: Start with heuristics. Replace with trained ML models later.

---

## Next Steps

1. Train direction, seller, and buyer models locally
2. Save models to `aegismatrix-engine/models/`
3. Update `direction/model.py`, `seller/model.py`, `buyer/model.py` to load & use real models
4. Test `infer.py` locally
5. Configure GitHub Actions secrets (Cloudflare API token, account ID)
6. Commit & push → CI/CD deploys to Cloudflare Pages
